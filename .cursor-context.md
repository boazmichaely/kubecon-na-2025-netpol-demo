# Cursor AI Session Context

**Date:** 2025-11-04  
**User:** Boaz Michaely (boazmichaely@github, boaz.michaely@gmail.com)

## Current Session Summary

### Major Accomplishments

1. **Demo Script (`demo.sh`) - Fully Functional**
   - Complete 3-demo workflow with interactive prompts
   - Command echoing with `set -x` / `{ set +x; } 2>/dev/null`
   - Cleanup section with conditional `oc delete`
   - Chrome window activation via `pop_chrome()` function
   - xdot visualization with geometry flag (`-g 1400x900`)
   - Color customization in DOT files via `sed`
   - ANP (AdminNetworkPolicy) integration in Demo 2
   - Location: `/Users/bmichael/code/GitHub/Kubernetes-demos/mostmark-microservices-demo/demo.sh`

2. **Homebrew Architecture Fixed**
   - Migrated to native ARM Homebrew (`/opt/homebrew/`)
   - Updated `~/.zshrc` to prioritize ARM Homebrew
   - VSCode CLI added to PATH

3. **Network Policy Analysis**
   - Created `DOT/frontend-connectivity-summary.md` - human-readable tables
   - Analyzed `DOT/explain.md` (683 lines from `roxctl netpol connectivity map --explain`)
   - Two tables: Egress (first, security priority) and Ingress
   - NO interpretations - only facts from explain.md
   - Understanding of `0.0.0.0-255.255.255.255` vs `{ingress-controller}` distinction

4. **AltTab Installed**
   - macOS window management improvement
   - Allows switching to individual windows (not all app windows)
   - Installed via Homebrew

### Demo Script Structure

**Demo 1 - Generate Network Policies and Visualize Connectivity**
- Step 1: Generate network policies (`roxctl netpol generate --dnsport 5353`)
- Step 2: Generate explicit connectivity map (DOT visualization with xdot)

**Demo 2 - How Tight Are the Network Policies?**
- Apply ANP for Prometheus monitoring (copy .txt to .yaml, view in less, apply, show in console)
- Step 3: Analyze exposure with focus on frontend (`roxctl netpol connectivity map --focus-workload frontend --exposure`)
- Color replacements: gold2→green, darkorange2→red

**Demo 3 - Why Are My Apps Not Talking?**
- Step 4: Explain connectivity for frontend (`roxctl netpol connectivity map --focus-workload frontend --explain`)
- Output to `DOT/explain.md`, view with `less`
- Return to slides at end

### Key Technical Details

**Bash Helper Functions:**
```bash
pop_chrome() {
    if [ -z "$1" ]; then
        osascript -e 'tell application "Google Chrome" to activate'
    else
        osascript <<EOF
tell application "Google Chrome"
    activate
    set windowList to every window
    repeat with aWindow in windowList
        if (title of aWindow) contains "$1" then
            set index of aWindow to 1
            set visible of aWindow to true
            exit repeat
        end if
    end repeat
end tell
EOF
    fi
}
```

**xdot Configuration:**
- Geometry: `-g 1400x900` (optimized for 15" MacBook Air M4 scaled resolution)
- Note: xdot is X11/GTK app, doesn't support native macOS full screen

**Color Replacements in DOT Files:**
```bash
sed -i '' 's/="gold2"/="#00FF00"/g' ../DOT/connectivity-map.dot
sed -i '' 's/="green"/="#00FF00"/g' ../DOT/frontend-connectivity-map.dot
sed -i '' 's/="darkorange2"/="#FF0000"/g' ../DOT/frontend-connectivity-map.dot
```

**Cleanup Strategy:**
```bash
if [ -f ../NETPOL/network-policies.yaml ]; then
    oc delete -f ../NETPOL/network-policies.yaml  2>/dev/null
fi
rm -f ../NETPOL/*.yaml
rm -f ../DOT/connectivity-map.dot
rm -f ../DOT/frontend-connectivity-map.dot
rm -f ../DOT/explain.md
```

### Important Files

**Demo Files:**
- `demo.sh` - Main demo script (185 lines)
- `DOT/explain.md` - Generated by roxctl (683 lines, focused on frontend)
- `DOT/frontend-connectivity-summary.md` - Human-readable tables (39 lines)
- `NETPOL/01-ANP-add-monitoring-with-ports-to-all-NS.txt` - ANP template for Demo 2
- `NETPOL/ANP-add-monitoring-with-ports-to-all-NS.yaml` - Applied ANP (copied from .txt during demo)

**Not Committed (Generated During Demo):**
- `DOT/connectivity-map.dot`
- `DOT/frontend-connectivity-map.dot`
- `NETPOL/network-policies.yaml`
- Various test files (`pop.sh`, `pop1.sh`, etc.)

### OpenShift Cluster Info

**Active Cluster:**
- Name: `boaz-for-ac49`
- KUBECONFIG: `~/.kube/config-boaz-for-ac49`
- Export command: `export KUBECONFIG=~/.kube/config-boaz-for-ac49`
- Test: `oc whoami --show-console`

**Namespace:** `ms-demo` (default)

**Key Resources:**
- Route: `frontend-ms-demo.apps.boaz-for-ac49.ocp.infra.rox.systems`
- AdminNetworkPolicy for Prometheus monitoring (ports 8080, 8443, 9090)

### Network Policy Deep Dive

**Critical Understanding:**
- `0.0.0.0-255.255.255.255` = All external IPs (outside cluster)
- `{ingress-controller}` = OpenShift ingress-controller pod (inside cluster)
- External traffic → Route → ingress-controller → frontend (ALLOWED)
- Direct external → frontend (BLOCKED, no ipBlock rules)
- Frontend egress to 0.0.0.0/0 BLOCKED (no data exfiltration)

**DNS Configuration:**
- Network policies allow UDP 5353 (not TCP 53)
- CoreDNS listens on port 5353 in the cluster
- `dnsPolicy: ClusterFirst` in application.yaml
- Previous issue: Port 53 caused 8-10 second delays (resolved)

**Frontend Connectivity (from explain.md):**
- Egress allowed to 7 backend services (specific TCP ports each)
- Ingress allowed from loadgenerator (TCP 8080) and ingress-controller (TCP 8080)
- No egress to external (0.0.0.0/0 blocked)
- No ingress from backends (correct - no reverse calls)

### macOS Configuration

**Homebrew:**
- ARM native at `/opt/homebrew/` (prioritized)
- Old Intel references removed from PATH

**~/.zshrc Updates:**
```bash
# Initialize ARM Homebrew (Apple Silicon native)
eval "$(/opt/homebrew/bin/brew shellenv)"

export PATH="/opt/homebrew/opt/coreutils/libexec/gnubin:$PATH"
export PATH="/Applications/Visual Studio Code.app/Contents/Resources/app/bin:$PATH"
```

**Tools Installed:**
- `xdot` - DOT file viewer
- `alt-tab` - Window management (individual window switching)
- VSCode CLI accessible via `code` command

**Markdown Viewing:**
- Preferred: `code <path>` then `Cmd+Shift+V` for preview
- Not Chrome (renders as text)
- Not glow (user didn't like it)
- Not macdown (security warning)

### Lessons Learned

1. **No Changes Without Permission** - User explicitly stated: "NEVER MAKE CHANGES TO MY CLUSTER WITHOUT MY PERMISSION !!!!!"
2. **No Interpretations in Analysis** - When organizing roxctl output, only use facts from the source, no interpretations
3. **Egress First** - Customers care more about egress (data exfiltration) than ingress
4. **macOS Limitations** - Chrome window activation brings all windows forward (macOS behavior, not scriptable)
5. **xdot is X11 app** - No native macOS integration, use geometry flag instead of full screen attempts

### Tool Command Reference

**roxctl Commands:**
```bash
# Generate network policies
roxctl netpol generate --dnsport 5353 . --remove -f ../NETPOL/network-policies.yaml

# Connectivity map (full)
roxctl netpol connectivity map .. -o dot -f ../DOT/connectivity-map.dot

# Connectivity map (focused with exposure)
roxctl netpol connectivity map .. --focus-workload frontend --exposure -o dot -f ../DOT/frontend-connectivity-map.dot --remove

# Explain connectivity
roxctl netpol connectivity map .. --focus-workload frontend --explain > ../DOT/explain.md
```

**Useful Aliases:**
```bash
ocwho  # Show OC context, user, server, project
```

### Git Status

**Latest Commit:**
```
[master bfcb471] Enhanced demo.sh with xdot, Chrome activation, ANP integration, and Demo 3; added frontend connectivity analysis
```

**Tracked Files:**
- demo.sh (modified)
- DOT/explain.md (new)
- DOT/frontend-connectivity-summary.md (new)
- NETPOL/01-ANP-add-monitoring-with-ports-to-all-NS.txt (new)

### Hardware

- **Laptop:** 15" MacBook Air M4 (2025)
- **Display:** 2880x1864 native, using scaled resolution
- **Effective Resolution:** ~1470x956
- **xdot Window:** 1400x900 (good fit)

### Next Steps

1. Test complete demo.sh workflow end-to-end
2. Possibly clean up test files (pop.sh, pop1.sh, old DOT files)
3. Consider adding more demos or refining existing ones
4. Document ANP usage patterns

### Known Issues

- None currently blocking demo

### User Preferences Summary

- Direct, factual communication
- No changes without explicit permission
- Security-first mindset (egress controls priority)
- Terminal-based workflows preferred
- Native tools over wrappers when possible
- Comprehensive commands over multiple simple ones
